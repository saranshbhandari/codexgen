import { Component, Input, OnInit } from '@angular/core';
import { FormArray, FormBuilder, FormGroup, Validators } from '@angular/forms';
import { FlowchartService } from '../../services/flowchart-service.service';
import { CustomModalService } from '../../services/custom-modal.service';
import { VariableManagerService } from '../../services/variable-manager.service';


@Component({
  selector: 'app-var-assignmentsettings',
  templateUrl: './var-assignmentsettings.component.html',
  styleUrls: ['./var-assignmentsettings.component.css']
})
export class VarAssignmentsettingsComponent implements OnInit {

  @Input() task: any;
  @Input() readonly: Boolean = true;

  form: FormGroup;

  Operations: Array<string> = ['SetTo', 'Increment', 'Decrement'];
  Variables: Array<string> = [];
  NumberVariables: Array<string> = [];

  constructor(
    private formbuilder: FormBuilder,
    private flowservice: FlowchartService,
    private custommodalservice: CustomModalService,
    private variableManagerService: VariableManagerService
  ) {
    // IMPORTANT: list-based form
    this.form = this.formbuilder.group({
      VariableMappingList: this.formbuilder.array([])
    });

    this.Variables = this.variableManagerService.workflowVariables
      .filter(x => x.editable === true)
      .map(x => `${x.scope}.${x.variableKey}`);

    this.NumberVariables = this.variableManagerService.workflowVariables
      .filter(x => x.scope === 'WORKFLOW' && x.editable === true && isNumber(x.variableValue))
      .map(x => `${x.scope}.${x.variableKey}`);
  }

  ngOnInit(): void {
    const list = this.task?.settings?.VariableMappingList;

    if (Array.isArray(list) && list.length > 0) {
      list.forEach((m: any) => this.addRow(m));
    } else {
      // default one row
      this.addRow();
    }
  }

  // ===== FormArray helpers =====
  get mappingList(): FormArray {
    return this.form.get('VariableMappingList') as FormArray;
  }

  private createRow(m?: any): FormGroup {
    return this.formbuilder.group({
      Variable: [m?.Variable ?? '', Validators.required],
      Operation: [m?.Operation ?? 'SetTo', Validators.required],
      Value: [m?.Value ?? '']
    });
  }

  addRow(m?: any): void {
    this.mappingList.push(this.createRow(m));
  }

  deleteRow(index: number): void {
    if (this.mappingList.length === 1) return; // keep at least one row
    this.mappingList.removeAt(index);
  }

  // ===== Validation rule you already had (now per-row) =====
  rowNeedsNumberVariable(row: FormGroup): boolean {
    const op = row.get('Operation')?.value;
    const variable = row.get('Variable')?.value;
    return op !== 'SetTo' && variable && !this.NumberVariables.includes(variable);
  }

  get hasAnyInvalidRow(): boolean {
    return this.mappingList.controls.some(ctrl => this.rowNeedsNumberVariable(ctrl as FormGroup));
  }

  onSaveClick(): void {
    // mimic your old behavior: if not SetTo -> clear Value (do this per row)
    this.mappingList.controls.forEach(ctrl => {
      const fg = ctrl as FormGroup;
      if (fg.get('Operation')?.value !== 'SetTo') {
        fg.patchValue({ Value: '' }, { emitEvent: false });
      }
    });

    // send the new list-based settings object (same shape as Java JSON)
    const payload = this.form.value; // { VariableMappingList: [...] }
    this.flowservice.updateTaskSettings(this.task.id, payload);
    this.custommodalservice.dismissAll();
  }

  close(): void {
    this.custommodalservice.dismissAll();
  }
}
